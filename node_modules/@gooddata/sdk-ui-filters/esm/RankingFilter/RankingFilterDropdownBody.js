// (C) 2020 GoodData Corporation
import React, { useState, useCallback } from "react";
import { Button, BubbleHoverTrigger, Bubble } from "@gooddata/sdk-ui-kit";
import { newRankingFilter, areObjRefsEqual } from "@gooddata/sdk-model";
import { injectIntl, FormattedMessage } from "react-intl";
import { OperatorDropdown } from "./OperatorDropdown/OperatorDropdown";
import { ValueDropdown } from "./ValueDropdown/ValueDropdown";
import { AttributeDropdown } from "./AttributeDropdown/AttributeDropdown";
import { MeasureDropdown } from "./MeasureDropdown/MeasureDropdown";
import isEqual from "lodash/isEqual";
import xorWith from "lodash/xorWith";
import isEmpty from "lodash/isEmpty";
import noop from "lodash/noop";
import { Preview } from "./Preview";
var isApplyButtonDisabled = function (filter, filterState) {
    var rankingFilter = filter.rankingFilter;
    var rankingFilterState = filterState.rankingFilter;
    var operatorNotChanged = rankingFilter.operator === rankingFilterState.operator;
    var valueNotChanged = rankingFilter.value === rankingFilterState.value;
    var attributesNotChanged = isEmpty(xorWith(rankingFilter.attributes, rankingFilterState.attributes, isEqual));
    var measureNotChanged = isEqual(rankingFilter.measure, rankingFilterState.measure);
    return operatorNotChanged && valueNotChanged && attributesNotChanged && measureNotChanged;
};
var RankingFilterDropdownBodyComponent = function (_a) {
    var _b;
    var measureItems = _a.measureItems, attributeItems = _a.attributeItems, filter = _a.filter, onApply = _a.onApply, onCancel = _a.onCancel, onDropDownItemMouseOver = _a.onDropDownItemMouseOver, onDropDownItemMouseOut = _a.onDropDownItemMouseOut, customGranularitySelection = _a.customGranularitySelection, intl = _a.intl;
    var rankingFilter = filter.rankingFilter;
    var _c = useState(rankingFilter.value), value = _c[0], setValue = _c[1];
    var _d = useState(rankingFilter.operator), operator = _d[0], setOperator = _d[1];
    var _e = useState(rankingFilter.measure), measure = _e[0], setMeasureIdentifier = _e[1];
    var _f = useState((_b = rankingFilter.attributes) === null || _b === void 0 ? void 0 : _b[0]), attribute = _f[0], setAttributeIdentifier = _f[1];
    var selectedMeasure = measureItems.find(function (item) { return areObjRefsEqual(item.ref, measure); });
    var selectedAttribute = attributeItems.find(function (item) { return areObjRefsEqual(item.ref, attribute); });
    var getFilterState = useCallback(function () {
        return attribute
            ? newRankingFilter(measure, [attribute], operator, value)
            : newRankingFilter(measure, operator, value);
    }, [measure, attribute, operator, value]);
    var applyHandler = function () {
        var filterState = getFilterState();
        onApply(filterState);
    };
    return (React.createElement("div", { className: "gd-dialog gd-dropdown overlay gd-rf-dropdown-body s-rf-dropdown-body" },
        React.createElement("div", { className: "gd-rf-dropdown-header" },
            React.createElement(FormattedMessage, { id: "rankingFilter.topBottom" })),
        React.createElement("div", { className: "gd-rf-dropdown-section" },
            React.createElement("div", { className: "gd-rf-value-section" },
                React.createElement(OperatorDropdown, { selectedValue: operator, onSelect: setOperator }),
                React.createElement(ValueDropdown, { selectedValue: value, onSelect: setValue }),
                React.createElement(BubbleHoverTrigger, { showDelay: 0, hideDelay: 0 },
                    React.createElement("span", { className: "gd-icon-circle-question gd-rf-value-tooltip-icon s-rf-value-tooltip-icon" }),
                    React.createElement(Bubble, { className: "bubble-primary gd-rf-tooltip-bubble s-rf-value-tooltip", alignPoints: [{ align: "cr cl" }, { align: "cl cr" }] },
                        React.createElement(FormattedMessage, { id: "rankingFilter.valueTooltip" })))),
            React.createElement("div", { className: "gd-rf-dropdown-section-title" },
                React.createElement(FormattedMessage, { id: "rankingFilter.outOf" })),
            React.createElement(AttributeDropdown, { items: attributeItems, selectedItemRef: attribute, onSelect: setAttributeIdentifier, onDropDownItemMouseOver: onDropDownItemMouseOver, onDropDownItemMouseOut: onDropDownItemMouseOut, customGranularitySelection: customGranularitySelection }),
            React.createElement("div", { className: "gd-rf-dropdown-section-title" },
                React.createElement(FormattedMessage, { id: "rankingFilter.basedOn" })),
            React.createElement(MeasureDropdown, { items: measureItems, selectedItemRef: measure, onSelect: setMeasureIdentifier, onDropDownItemMouseOver: onDropDownItemMouseOver, onDropDownItemMouseOut: onDropDownItemMouseOut }),
            React.createElement("div", { className: "gd-rf-dropdown-section-title" },
                React.createElement(FormattedMessage, { id: "rankingFilter.preview" })),
            React.createElement(Preview, { measure: selectedMeasure, attribute: selectedAttribute, operator: operator, value: value })),
        React.createElement("div", { className: "gd-rf-dropdown-footer" },
            React.createElement(Button, { className: "gd-button-secondary gd-button-small s-rf-dropdown-cancel", onClick: function () { return onCancel(); }, value: intl.formatMessage({ id: "cancel" }) }),
            React.createElement(Button, { className: "gd-button-action gd-button-small s-rf-dropdown-apply", onClick: applyHandler, value: intl.formatMessage({ id: "apply" }), disabled: isApplyButtonDisabled(filter, getFilterState()) }))));
};
RankingFilterDropdownBodyComponent.defaultProps = {
    onCancel: noop,
};
export var RankingFilterDropdownBody = injectIntl(RankingFilterDropdownBodyComponent);
//# sourceMappingURL=RankingFilterDropdownBody.js.map