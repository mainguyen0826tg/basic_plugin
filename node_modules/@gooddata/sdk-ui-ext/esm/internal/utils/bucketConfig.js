// (C) 2019-2021 GoodData Corporation
import forEach from "lodash/forEach";
import set from "lodash/set";
import isEmpty from "lodash/isEmpty";
import includes from "lodash/includes";
import isEqual from "lodash/isEqual";
import cloneDeep from "lodash/cloneDeep";
import { OverTimeComparisonTypes } from "@gooddata/sdk-ui";
import { METRIC, SHOW_IN_PERCENT } from "../constants/bucket";
import { filterOutDerivedMeasures, filterOutArithmeticMeasuresFromDerived, getComparisonTypeFromFilters, keepOnlyMasterAndDerivedMeasuresOfType, filterOutIncompatibleArithmeticMeasures, isComparisonAvailable, removeAllDerivedMeasures, } from "./bucketHelper";
import { isShowInPercentAllowed, isComparisonOverTimeAllowed } from "./bucketRules";
function getTypeOfDerivedToKeep(supportedTypes, appliedType) {
    return isEmpty(supportedTypes) || isEqual(supportedTypes, [OverTimeComparisonTypes.NOTHING])
        ? OverTimeComparisonTypes.NOTHING
        : appliedType;
}
export function configureOverTimeComparison(extendedReferencePoint, weekFiltersEnabled) {
    var newExtendedReferencePoint = cloneDeep(extendedReferencePoint);
    var buckets = newExtendedReferencePoint.buckets, filters = newExtendedReferencePoint.filters, uiConfig = newExtendedReferencePoint.uiConfig;
    var supportedOverTimeComparisonTypes = uiConfig.supportedOverTimeComparisonTypes;
    var appliedComparisonType = getComparisonTypeFromFilters(filters);
    var isSelectedComparisonSupportedByVis = includes(supportedOverTimeComparisonTypes, appliedComparisonType);
    var derivedOfTypeToKeep = getTypeOfDerivedToKeep(supportedOverTimeComparisonTypes, appliedComparisonType);
    var comparisonOverTimeAllowed = isComparisonOverTimeAllowed(buckets, filters, weekFiltersEnabled);
    var originalBuckets = cloneDeep(buckets);
    forEach(buckets, function (bucket) {
        var newItems = bucket.items;
        if (!comparisonOverTimeAllowed) {
            newItems = filterOutArithmeticMeasuresFromDerived(newItems, originalBuckets);
            newItems = filterOutDerivedMeasures(newItems);
        }
        if (!isSelectedComparisonSupportedByVis) {
            newItems = filterOutIncompatibleArithmeticMeasures(newItems, originalBuckets, derivedOfTypeToKeep);
            newItems = keepOnlyMasterAndDerivedMeasuresOfType(newItems, derivedOfTypeToKeep);
        }
        bucket.items = newItems;
    });
    if (!isComparisonAvailable(buckets, filters)) {
        newExtendedReferencePoint = removeAllDerivedMeasures(newExtendedReferencePoint);
    }
    return newExtendedReferencePoint;
}
function removeShowInPercent(measure) {
    return set(measure, SHOW_IN_PERCENT, null);
}
export function configurePercent(extendedReferencePoint, percentDisabled) {
    if (percentDisabled === void 0) { percentDisabled = false; }
    forEach(extendedReferencePoint.buckets, function (bucket) {
        var showInPercentEnabled = !percentDisabled &&
            isShowInPercentAllowed(extendedReferencePoint.buckets, extendedReferencePoint.filters, bucket.localIdentifier);
        if (!showInPercentEnabled) {
            bucket.items.forEach(function (measure) {
                if (measure.type === METRIC) {
                    removeShowInPercent(measure);
                }
            });
        }
        var bucketUiConfig = extendedReferencePoint.uiConfig.buckets[bucket.localIdentifier];
        if (bucketUiConfig.accepts.indexOf(METRIC) >= 0) {
            bucketUiConfig.isShowInPercentEnabled = showInPercentEnabled;
        }
    });
    return extendedReferencePoint;
}
//# sourceMappingURL=bucketConfig.js.map