// (C) 2007-2021 GoodData Corporation
import { isDashboardAttributeFilter, isDashboardDateFilter, } from "@gooddata/sdk-backend-spi";
import { absoluteDateFilterValues, areObjRefsEqual, attributeElementsIsEmpty, filterAttributeElements, filterIsEmpty, filterObjRef, isAllTimeDateFilter, isAttributeElementsByRef, isAttributeFilter, isDateFilter, isNegativeAttributeFilter, isRelativeDateFilter, relativeDateFilterValues, } from "@gooddata/sdk-model";
import isEqual from "lodash/isEqual";
import last from "lodash/last";
import sortBy from "lodash/sortBy";
export function isKpiAlertDateFilterSameAsDashboard(alert, appliedFilters) {
    var _a, _b, _c;
    var alertDateFilter = (_a = alert === null || alert === void 0 ? void 0 : alert.filterContext) === null || _a === void 0 ? void 0 : _a.filters.find(isDashboardDateFilter);
    var appliedDateFilter = last(appliedFilters.filter(isDateFilter));
    if (!alertDateFilter) {
        return !appliedDateFilter || isAllTimeDateFilter(appliedDateFilter);
    }
    if (!appliedDateFilter || isAllTimeDateFilter(appliedDateFilter)) {
        return false;
    }
    if (isRelativeDateFilter(appliedDateFilter)) {
        var _d = relativeDateFilterValues(appliedDateFilter), from = _d.from, granularity = _d.granularity, to = _d.to;
        var sameType = alertDateFilter.dateFilter.type === "relative";
        var sameFrom = ((_b = alertDateFilter.dateFilter.from) === null || _b === void 0 ? void 0 : _b.toString()) === from.toString();
        var sameTo = ((_c = alertDateFilter.dateFilter.to) === null || _c === void 0 ? void 0 : _c.toString()) === to.toString();
        var sameGranularity = alertDateFilter.dateFilter.granularity === granularity;
        return [sameType, sameFrom, sameTo, sameGranularity].every(Boolean);
    }
    else {
        var _e = absoluteDateFilterValues(appliedDateFilter), from = _e.from, to = _e.to;
        var sameType = alertDateFilter.dateFilter.type === "absolute";
        var sameFrom = alertDateFilter.dateFilter.from === from;
        var sameTo = alertDateFilter.dateFilter.to === to;
        return [sameType, sameFrom, sameTo].every(Boolean);
    }
}
function areKpiAlertAttributeFiltersSameAsDashboard(alert, appliedFilters) {
    var _a, _b;
    var alertAttributeFilters = (_b = (_a = alert.filterContext) === null || _a === void 0 ? void 0 : _a.filters.filter(isDashboardAttributeFilter)) !== null && _b !== void 0 ? _b : [];
    var appliedAttributeFilters = appliedFilters.filter(isAttributeFilter);
    // empty filter is modelled as negative filter with no elements
    var alertAttributeFiltersWithoutEmpty = alertAttributeFilters.filter(function (filter) {
        return !(filter.attributeFilter.negativeSelection &&
            attributeElementsIsEmpty(filter.attributeFilter.attributeElements));
    });
    var appliedAttributeFiltersWithoutEmpty = appliedAttributeFilters.filter(function (filter) { return !(isNegativeAttributeFilter(filter) && filterIsEmpty(filter)); });
    // the filters are considered the same if the count of non-empty filters is matching
    // and every filter in alert has an equivalent in the applied filters
    return (appliedAttributeFiltersWithoutEmpty.length === alertAttributeFiltersWithoutEmpty.length &&
        appliedAttributeFiltersWithoutEmpty.every(function (filter) {
            var displayForm = filterObjRef(filter);
            var found = alertAttributeFiltersWithoutEmpty.find(function (alertFilter) {
                return areObjRefsEqual(alertFilter.attributeFilter.displayForm, displayForm);
            });
            if (!found) {
                return false;
            }
            var negativeSelectionSame = found.attributeFilter.negativeSelection === isNegativeAttributeFilter(filter);
            var filterElements = filterAttributeElements(filter);
            var elementsSame = isAttributeElementsByRef(filterElements) && // TODO what about filters by value?
                isAttributeElementsByRef(found.attributeFilter.attributeElements) && // TODO what about filters by value?
                isEqual(sortBy(found.attributeFilter.attributeElements.uris), sortBy(filterElements.uris));
            return negativeSelectionSame && elementsSame;
        }));
}
export function areKpiAlertFiltersSameAsDashboard(alert, appliedFilters) {
    return (!!alert &&
        isKpiAlertDateFilterSameAsDashboard(alert, appliedFilters) &&
        areKpiAlertAttributeFiltersSameAsDashboard(alert, appliedFilters));
}
//# sourceMappingURL=filterUtils.js.map