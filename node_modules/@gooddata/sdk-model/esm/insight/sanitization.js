// (C) 2020 GoodData Corporation
import { InvariantError } from "ts-invariant";
import { insightAttributes, insightBuckets, insightSetBuckets, insightSorts } from ".";
import { bucketAttributeIndex, bucketSetTotals, bucketTotals } from "../execution/buckets";
import { isAttributeSort, isMeasureSort, sortEntityIds } from "../execution/base/sort";
import { attributeLocalId } from "../execution/attribute";
/**
 * Makes sure the insight does not have any nonsensical data (like totals that no longer make sense, etc.), before it is saved.
 *
 * @param insight - the insight or insight definition to sanitize
 * @public
 */
export function insightSanitize(insight) {
    return removeInvalidTotals(insight);
}
function removeInvalidTotals(insight) {
    var sortItems = insightSorts(insight);
    var attributeIdentifiers = insightAttributes(insight).map(attributeLocalId);
    var sanitizedBuckets = insightBuckets(insight).map(function (bucket) {
        var totals = bucketTotals(bucket);
        if (totals.length && isSortedOnDifferentThanFirstAttributeInBucket(bucket, sortItems)) {
            bucket.totals = getBucketTotalsWithoutSubtotals(bucket);
            if (totals.length === 0) {
                return bucketSetTotals(bucket, []);
            }
        }
        var sanitizedTotals = totals.filter(function (total) {
            return attributeIdentifiers.includes(total.attributeIdentifier);
        });
        if (sanitizedTotals.length !== totals.length) {
            return bucketSetTotals(bucket, sanitizedTotals);
        }
        return bucket;
    });
    return insightSetBuckets(insight, sanitizedBuckets);
}
function isSortedOnDifferentThanFirstAttributeInBucket(bucket, sortItems) {
    return sortItems.some(function (sortItem) {
        if (isAttributeSort(sortItem)) {
            var attributeIdentifier = sortEntityIds(sortItem).attributeIdentifiers[0];
            var attributeIndex = bucketAttributeIndex(bucket, attributeIdentifier);
            return attributeIndex > 0;
        }
        else if (isMeasureSort(sortItem)) {
            return true;
        }
        throw new InvariantError('Unexpected sortType, only supported sortTypes are "attributeSortItem" and "measureSortItem"');
    });
}
function getBucketTotalsWithoutSubtotals(bucket) {
    return bucketTotals(bucket).filter(function (total) { return bucketAttributeIndex(bucket, total.attributeIdentifier) === 0; });
}
//# sourceMappingURL=sanitization.js.map